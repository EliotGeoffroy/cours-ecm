
include::../../header.adoc[]

image::banner.png[width=100%]

Mongo db est une base de donn√©es qui contient des documents.

Les donn√©es sont stock√©es en Binary JSON (BSON).

Nous allons l'utiliser afin de stocker nos donn√©es.

== Des documents

Un document est une structure de donn√©es flexible. La tructure peut √™tre riche, par opposition √† des cl√©s-valeurs.

Les documents Mongo db sont des structures arborescentes pouvant contenir des tableaux.

[source]
.exemple
----
{
   _id: ObjectId("5099803df3f4948bd2f98391"),
   name: { first: "Alan", last: "Turing" },
   birth: new Date('Jun 23, 1912'),
   death: new Date('Jun 07, 1954'),
   contribs: [ "Turing machine", "Turing test", "Turingery" ],
   views : NumberLong(1250000)
}
----

C'est un arbre classique JSON avec un attribut _id de type ObjectId.

.Not Only SQL (wikipedia)
****
En informatique, *NoSQL* (Not only SQL en anglais) d√©signe une cat√©gorie de syst√®mes de gestion de base de donn√©es (SGBD) qui n'est plus fond√©e sur l'architecture classique des *bases relationnelles*. L'unit√© logique n'y est plus la table, et les donn√©es ne sont en g√©n√©ral pas manipul√©es avec SQL.
****

== Collections

Les documents sont rang√©s dans des *collections* (l'√©quivalent des tables en sql).

Les collections sont beaucoup moins rigides que les tables :
il n'y a pas de sch√©ma et donc chaque document peut avoir sa propre structure.

Cela n'emp√™che pas de pouvoir positionner des index sur les propri√©t√©s afin d'assurer la performance des lectures.

== Shell & Javascript

Pour interagir avec la base, il est possible d'utiliser le shell mongo.

****
The mongo shell is an interactive *JavaScript* interface to MongoDB and is a component of the MongoDB package.
You can use the mongo shell to query and update data as well as perform administrative operations.
****

L'https://docs.mongodb.org/manual/reference/method/[api mongo] est riche et bien document√©e.

.Exemple de requ√™te
----
db.inventory.find( { type: 'food', price: { $lt: 9.95 } } ) <1>
----
<1> on cherche les documents de type 'food' avec un prix inf√©rieur √† 9.95 dans la collection 'inventory'

En java, on utilise un **driver**.
Selon le language et les frameworks, la fa√ßon d'interagir avec la base mongo peut donc varier.

== Replica Sets

L'origine des bases NoSql vise la performance sur des volumes de donn√©es importants.

Mongodb propose des replica sets : un groupe de process qui maintiennent les m√™mes donn√©es.

Cela apporte *haute disponibilit√©* (tol√©rance √† la panne) et *redondance* (tol√©rance √† la perte de donn√©es sur un noeud).

Un replica set contient toujours un serveur primaire et des secondaires.

.Replicat set
image::replica-set.png[align="center"]

Pour augmenter la performance, il est possible que les clients viennent lire sur les secondaires.
Il se peut donc qu'au moment de la lecture, les donn√©es ne soient pas encore r√©pliqu√©es vers les secondaires.

.Eventual Consistency
[quote, Amazon, Eventual Consistency]
the storage system guarantees that if no new updates are made to the object, eventually all accesses will return the last updated value.

== Sharding

Le sharding est l'√©clatement des donn√©es en sous ensembles.

Cela permet aux requ√™tes d'√™tre distribu√©es entres plusieurs serveurs afin de travailler sur des volumes plus faibles.

.Shards
image::shards.png[align="center"]

Afin de pouvoir r√©partir une collection sur plusieurs serveurs, il faut d√©finir une cl√© de sharding.

Les donn√©es seront alors r√©parties en fonction de cette cl√©.

.Logs
****
Un exemple de sharding pourrait concerner les logs : le volume est souvent imposant.

Il serait possible de diviser les logs en se basant sur la date du log.

Ainsi, les requ√™tes seraient r√©parties entre les noeuds pour plus de perfomance.
****

== Map reduce

Une des op√©ration qui a rendu c√©l√®bre les bases NoSQL est le *map-reduce* : c'est un m√©canisme de traitement en masse des donn√©es afin de fournir un r√©sultat aggr√©g√©.

* map : transformation des r√©sultats
* reduce : aggr√©gation du r√©sultat

.Map reduce
image::map-reduce.png[align="center"]

Le principe se marie id√©alement avec du sharding o√π les op√©ration peuvent op√©rer sur tous les noeuds en m√™me temps avant que le r√©sultat final soit aggr√©g√©.

== SQL vs MongoDB

Les qualit√©s d'une base SQL sont :

* *A* tomicit√© : une transaction se fait au complet ou pas du tout
* *C* oh√©rence : chaque transaction am√®nera le syst√®me d'un √©tat valide √† un autre √©tat valide
* *I* solation : toute transaction doit s'ex√©cuter comme si elle √©tait la seule sur le syst√®me
* *D* urabilit√© : une transaction finalis√©e alt√®re les donn√©es fa√ßon permanente et resistante √† la panne

Or mongodb ne supporte ni transaction, ni cl√© √©trang√®re. Donc pas d'**ACID**it√©.

En contrepartie de ces d√©fauts, mongodb apporte plus de perfomance, plus de souplesse et plus de simplicit√©.

== Installation

Pour installer mongodb on passe par homebrew :

[source.terminal]
----
projects$ brew install mongodb
==> Downloading https://homebrew.bintray.com/bottles/mongodb-3.0.6.yosemite.bottle.tar.gz
######################################################################## 100,0%
==> Pouring mongodb-3.0.6.yosemite.bottle.tar.gz
==> Caveats
To have launchd start mongodb at login:
  ln -sfv /usr/local/opt/mongodb/*.plist ~/Library/LaunchAgents
Then to load mongodb now:
  launchctl load ~/Library/LaunchAgents/homebrew.mxcl.mongodb.plist
Or, if you don't want/need launchctl, you can just run:
  mongod --config /usr/local/etc/mongod.conf
==> Summary
üç∫  /usr/local/Cellar/mongodb/3.0.6: 17 files, 159M
----

== Cr√©ation du r√©pertoire de donn√©es

[source.terminal]
----
projects$ mkdir mongodb-data <1>
----
<1> ce r√©pertoire contiendra les donn√©es de la base

== Lancer la base

Une fois install√©e, il suffit de lancer la base.

[source.terminal]
----
projects$ mongod --dbpath mongodb-data
2015-06-12T17:53:52.757+0200 I JOURNAL  [initandlisten] journal dir=mongodb-data/journal
2015-06-12T17:53:52.757+0200 I JOURNAL  [initandlisten] recover : no journal files present, no recovery needed
2015-06-12T17:53:52.783+0200 I JOURNAL  [durability] Durability thread started
2015-06-12T17:53:52.783+0200 I CONTROL  [initandlisten] MongoDB starting : pid=3015 port=27017 dbpath=mongodb-data 64-bit host=jaadtwo.local
2015-06-12T17:53:52.783+0200 I JOURNAL  [journal writer] Journal writer thread started
2015-06-12T17:53:52.783+0200 I CONTROL  [initandlisten] db version v3.0.1
2015-06-12T17:53:52.784+0200 I CONTROL  [initandlisten] git version: nogitversion
2015-06-12T17:53:52.784+0200 I CONTROL  [initandlisten] build info: Darwin mavericksvm.local 13.4.0 Darwin Kernel Version 13.4.0: Wed Dec 17 19:05:52 PST 2014; root:xnu-2422.115.10~1/RELEASE_X86_64 x86_64 BOOST_LIB_VERSION=1_49
2015-06-12T17:53:52.784+0200 I CONTROL  [initandlisten] allocator: system
2015-06-12T17:53:52.784+0200 I CONTROL  [initandlisten] options: { storage: { dbPath: "mongodb-data" } }
2015-06-12T17:53:52.850+0200 I NETWORK  [initandlisten] waiting for connections on port 27017 <1>
----
<1> La base √©coute sur le port 27017

La base est pr√™te √† recevoir des connexions.

== Robomongo

On pourrait utiliser le shell mais une interface graphique est plus simple pour viasualis√© les r√©sultats des requ√™tes.

Il existe beaucoup de https://docs.mongodb.org/ecosystem/tools/administration-interfaces/[clients graphiques]

Nous utiliserons http://robomongo.org/[robomongo].

Installez ce logiciel et connectez vous √† la base en local sur le port 27017.

Une fois connect√©, vous pouvez cr√©er une base, des collections et faire de multiples https://docs.mongodb.org/manual/tutorial/query-documents/[requ√™tes].

image::robomongo.png[]

include::../../footer.adoc[]